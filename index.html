<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音声メッセージ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Sans', 'Yu Gothic', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.15);
            padding: 40px 30px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            max-width: 400px;
            width: 90vw;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .pulse-circle {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            animation: pulse 2s infinite;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
        }
        
        .pulse-circle:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 35px rgba(255, 107, 107, 0.5);
        }
        
        @keyframes pulse {
            0% { 
                transform: scale(1);
                box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
            }
            50% { 
                transform: scale(1.08);
                box-shadow: 0 15px 35px rgba(255, 107, 107, 0.6);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
            }
        }
        
        .title {
            font-size: 24px;
            margin-bottom: 15px;
            font-weight: 300;
            letter-spacing: 1px;
        }
        
        .status {
            font-size: 16px;
            margin: 20px 0;
            opacity: 0.9;
            min-height: 20px;
        }
        
        .tap-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            cursor: pointer;
        }
        
        .audio-hidden {
            position: absolute;
            left: -9999px;
            width: 1px;
            height: 1px;
            opacity: 0;
        }
        
        .controls {
            margin-top: 30px;
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        .controls.visible {
            opacity: 1;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .footer-text {
            margin-top: 30px;
            font-size: 14px;
            opacity: 0.8;
            line-height: 1.4;
        }
        
        .loading-spinner {
            display: none;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* モバイル特有の最適化 */
        @media (max-width: 480px) {
            .container {
                padding: 30px 20px;
                border-radius: 15px;
            }
            
            .pulse-circle {
                width: 100px;
                height: 100px;
                font-size: 35px;
            }
            
            .title {
                font-size: 20px;
            }
        }
        
        /* フルスクリーンモード */
        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .fullscreen-overlay.active {
            display: flex;
        }
        
        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- フルスクリーン音声再生領域 -->
    <div class="tap-area" id="tapArea"></div>
    
    <div class="container" id="mainContainer">
        <div class="pulse-circle" id="playCircle">
            <span id="playIcon">🎵</span>
        </div>
        
        <h1 class="title">音声メッセージ</h1>
        <div class="status" id="status">画面をタップして再生</div>
        
        <div class="loading-spinner" id="loadingSpinner"></div>
        
        <div class="controls" id="controls">
            <button class="control-btn" id="playBtn" onclick="toggleAudio()">▶ 再生</button>
            <button class="control-btn" id="pauseBtn" onclick="pauseAudio()">⏸ 停止</button>
        </div>
        
        <div class="footer-text">
            QRコードからアクセスしていただき、<br>ありがとうございます！
        </div>
    </div>
    
    <!-- 隠し音声要素（複数のフォールバック） -->
    <audio class="audio-hidden" id="audioMain" preload="auto" crossorigin="anonymous">
        <source src="./MenzuT-Kenshin.mp3" type="audio/mpeg">
        <source src="MenzuT-Kenshin.mp3" type="audio/mpeg">
        <source src="./audio/MenzuT-Kenshin.mp3" type="audio/mpeg">
    </audio>
    
    <!-- フルスクリーンオーバーレイ -->
    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <button class="close-btn" onclick="closeFullscreen()">×</button>
        <div class="pulse-circle" style="margin-bottom: 30px;">
            <span>🎧</span>
        </div>
        <h2>音声を再生中...</h2>
    </div>

    <script>
        const audio = document.getElementById('audioMain');
        const status = document.getElementById('status');
        const playCircle = document.getElementById('playCircle');
        const playIcon = document.getElementById('playIcon');
        const controls = document.getElementById('controls');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const tapArea = document.getElementById('tapArea');
        const fullscreenOverlay = document.getElementById('fullscreenOverlay');
        
        let audioContext = null;
        let isPlaying = false;
        let audioReady = false;
        let userInteracted = false;
        let autoPlayTriggered = false;
        
        // 最適化されたオーディオ設定
        audio.volume = 0.85;
        audio.preload = 'auto';
        
        // ページ読み込み完了時
        window.addEventListener('load', function() {
            initializeAudio();
            setupInteractionListeners();
            
            // 段階的自動再生試行
            setTimeout(tryImmediateAutoPlay, 100);
            setTimeout(tryDelayedAutoPlay, 300);
            setTimeout(showReadyState, 1000);
        });
        
        function initializeAudio() {
            // 音声コンテキストの準備
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('AudioContext not supported');
            }
            
            // 音声イベントリスナー
            audio.addEventListener('canplaythrough', function() {
                audioReady = true;
                hideLoading();
                updateStatus('🎵 タップで音声を再生');
                playIcon.textContent = '🎵';
            });
            
            audio.addEventListener('play', function() {
                isPlaying = true;
                playIcon.textContent = '🔊';
                updateStatus('🎵 再生中...');
                controls.classList.add('visible');
                showFullscreen();
            });
            
            audio.addEventListener('pause', function() {
                isPlaying = false;
                playIcon.textContent = '🎵';
                updateStatus('音声を停止しました');
                hideFullscreen();
            });
            
            audio.addEventListener('ended', function() {
                isPlaying = false;
                playIcon.textContent = '✅';
                updateStatus('再生完了！');
                hideFullscreen();
            });
            
            audio.addEventListener('error', function(e) {
                hideLoading();
                playIcon.textContent = '❌';
                updateStatus('音声読み込みエラー');
                console.error('Audio error:', e);
            });
        }
        
        function setupInteractionListeners() {
            // あらゆるユーザー操作を検知
            const interactionEvents = [
                'touchstart', 'touchend', 'touchmove',
                'mousedown', 'mouseup', 'mousemove',
                'click', 'keydown', 'scroll',
                'gesturestart', 'gesturechange', 'gestureend'
            ];
            
            interactionEvents.forEach(event => {
                document.addEventListener(event, handleFirstInteraction, {
                    once: true,
                    passive: true,
                    capture: true
                });
            });
            
            // タップエリアの設定
            tapArea.addEventListener('click', handleTapToPlay);
            playCircle.addEventListener('click', handleTapToPlay);
            
            // モバイル特有のイベント
            window.addEventListener('orientationchange', function() {
                setTimeout(tryAutoPlay, 100);
            });
            
            // ページフォーカス
            window.addEventListener('focus', function() {
                if (!autoPlayTriggered) {
                    setTimeout(tryAutoPlay, 50);
                }
            });
        }
        
        function handleFirstInteraction() {
            userInteracted = true;
            
            // AudioContextの再開
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    console.log('AudioContext resumed');
                });
            }
            
            // 少し遅延してから自動再生
            setTimeout(tryAutoPlay, 50);
        }
        
        function handleTapToPlay(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (!audioReady) {
                showLoading();
                updateStatus('音声を準備中...');
                return;
            }
            
            playAudio();
        }
        
        function tryImmediateAutoPlay() {
            if (audioReady) {
                tryAutoPlay();
            }
        }
        
        function tryDelayedAutoPlay() {
            if (!autoPlayTriggered && audioReady) {
                tryAutoPlay();
            }
        }
        
        function tryAutoPlay() {
            if (autoPlayTriggered || !audioReady) return;
            
            const playPromise = audio.play();
            
            if (playPromise) {
                playPromise.then(() => {
                    autoPlayTriggered = true;
                    console.log('Auto-play successful');
                }).catch(error => {
                    console.log('Auto-play prevented:', error.message);
                    // 自動再生失敗時の視覚的フィードバック
                    playCircle.style.animation = 'pulse 1.5s infinite';
                });
            }
        }
        
        function playAudio() {
            if (!audioReady) return;
            
            showLoading();
            
            const playPromise = audio.play();
            
            if (playPromise) {
                playPromise.then(() => {
                    hideLoading();
                    autoPlayTriggered = true;
                    tapArea.style.display = 'none'; // タップエリアを非表示
                }).catch(error => {
                    hideLoading();
                    updateStatus('再生エラー: ' + error.message);
                    console.error('Play error:', error);
                });
            }
        }
        
        function toggleAudio() {
            if (isPlaying) {
                audio.pause();
            } else {
                playAudio();
            }
        }
        
        function pauseAudio() {
            audio.pause();
        }
        
        function showReadyState() {
            if (!audioReady && !autoPlayTriggered) {
                updateStatus('🎵 画面をタップして再生開始');
                playCircle.style.animation = 'pulse 2s infinite';
            }
        }
        
        function showLoading() {
            loadingSpinner.style.display = 'block';
        }
        
        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }
        
        function updateStatus(message) {
            status.textContent = message;
        }
        
        function showFullscreen() {
            if (window.innerWidth <= 768) { // モバイルでのみ表示
                fullscreenOverlay.classList.add('active');
            }
        }
        
        function hideFullscreen() {
            fullscreenOverlay.classList.remove('active');
        }
        
        function closeFullscreen() {
            hideFullscreen();
            pauseAudio();
        }
        
        // モバイルブラウザ特有の対策
        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
            // iOS Safari用の特別な設定
            audio.load();
            
            // Web Audio APIによる追加最適化
            if (audioContext) {
                const source = audioContext.createMediaElementSource(audio);
                const gainNode = audioContext.createGain();
                source.connect(gainNode);
                gainNode.connect(audioContext.destination);
                gainNode.gain.value = 1.0;
            }
            
            // バックグラウンド再生対応
            document.addEventListener('visibilitychange', function() {
                if (document.hidden && isPlaying) {
                    // バックグラウンドでも継続再生
                    console.log('Background play mode');
                } else if (!document.hidden && !isPlaying) {
                    // フォアグラウンド復帰時の再開試行
                    setTimeout(tryAutoPlay, 100);
                }
            });
        }
        
        // デバッグ情報（本番では削除可能）
        console.log('Mobile audio system initialized');
        console.log('User agent:', navigator.userAgent);
        console.log('Audio support:', audio.canPlayType('audio/mpeg'));
    </script>
</body>
</html>
