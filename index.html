<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音声メッセージ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            max-width: 500px;
            width: 90vw;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .music-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        
        .title {
            font-size: 28px;
            margin-bottom: 20px;
            font-weight: 300;
        }
        
        .status {
            font-size: 18px;
            margin: 25px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .controls {
            margin: 30px 0;
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        .controls.visible {
            opacity: 1;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .btn.stop {
            background: #f44336;
        }
        
        .btn.stop:hover {
            background: #d32f2f;
        }
        
        .hidden-audio {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }
        
        .success-message {
            background: rgba(76, 175, 80, 0.3);
            color: #c8e6c9;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        
        .footer {
            margin-top: 30px;
            opacity: 0.8;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container" onclick="handleUserInteraction()">
        <div class="music-icon" id="musicIcon">🎵</div>
        <h1 class="title">音声メッセージ</h1>
        
        <div class="status" id="status">
            <span class="loading" id="loading"></span>
            音声を準備中...
        </div>
        
        <div class="success-message" id="successMsg">
            🎉 音声が自動再生されました！
        </div>
        
        <div class="controls" id="controls">
            <button class="btn" id="playBtn" onclick="playAudio()">▶ 再生</button>
            <button class="btn stop" id="stopBtn" onclick="stopAudio()">⏹ 停止</button>
        </div>
        
        <div class="footer">
            QRコードからアクセスいただき<br>ありがとうございます！
        </div>
    </div>
    
    <!-- 複数の音声要素で確実性を向上 -->
    <audio class="hidden-audio" id="mainAudio" preload="auto">
        <source src="./MenzuT-Kenshin.mp3" type="audio/mpeg">
    </audio>
    
    <audio class="hidden-audio" id="backupAudio" preload="auto">
        <source src="./MenzuT-Kenshin.mp3" type="audio/mpeg">
    </audio>

    <script>
        const mainAudio = document.getElementById('mainAudio');
        const backupAudio = document.getElementById('backupAudio');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        const musicIcon = document.getElementById('musicIcon');
        const controls = document.getElementById('controls');
        const successMsg = document.getElementById('successMsg');
        
        let audioReady = false;
        let isPlaying = false;
        let userHasInteracted = false;
        let autoplayAttempted = false;
        
        // 音声設定
        mainAudio.volume = 0.8;
        backupAudio.volume = 0.8;
        
        // ページロード時に初期化
        window.addEventListener('load', function() {
            console.log('🎵 音声システム初期化開始');
            setupAudioEvents();
            prepareForAutoplay();
        });
        
        function setupAudioEvents() {
            // メイン音声の準備完了イベント
            mainAudio.addEventListener('canplaythrough', function() {
                console.log('✅ メイン音声準備完了');
                onAudioReady();
            });
            
            // バックアップ音声の準備完了イベント
            backupAudio.addEventListener('canplaythrough', function() {
                console.log('✅ バックアップ音声準備完了');
                if (!audioReady) {
                    onAudioReady();
                }
            });
            
            // 再生開始イベント
            mainAudio.addEventListener('play', function() {
                onPlayStart();
            });
            
            backupAudio.addEventListener('play', function() {
                onPlayStart();
            });
            
            // 再生終了イベント
            mainAudio.addEventListener('ended', function() {
                onPlayEnd();
            });
            
            backupAudio.addEventListener('ended', function() {
                onPlayEnd();
            });
            
            // エラーハンドリング
            mainAudio.addEventListener('error', function(e) {
                console.error('メイン音声エラー:', e);
                tryBackupAudio();
            });
            
            backupAudio.addEventListener('error', function(e) {
                console.error('バックアップ音声エラー:', e);
                showError();
            });
        }
        
        function prepareForAutoplay() {
            // ユーザーインタラクション検知の準備
            const interactionEvents = [
                'touchstart', 'touchend', 'touchmove',
                'mousedown', 'mouseup', 'click',
                'keydown', 'scroll'
            ];
            
            interactionEvents.forEach(event => {
                document.addEventListener(event, handleUserInteraction, {
                    once: true,
                    passive: true
                });
            });
        }
        
        function handleUserInteraction() {
            if (!userHasInteracted) {
                userHasInteracted = true;
                console.log('👆 ユーザーインタラクション検知');
                
                if (audioReady && !autoplayAttempted) {
                    attemptAutoplay();
                }
            }
        }
        
        // 音声準備完了時の処理（ここが重要！）
        function onAudioReady() {
            audioReady = true;
            console.log('🎯 音声準備完了 - 自動再生開始');
            
            hideLoading();
            status.innerHTML = '🎵 音声準備完了！';
            
            // 準備完了の瞬間に自動再生試行
            setTimeout(attemptAutoplay, 100);
            setTimeout(attemptAutoplay, 300);
            setTimeout(attemptAutoplay, 500);
            
            // ユーザーが既に操作している場合も即座に再生
            if (userHasInteracted) {
                attemptAutoplay();
            }
        }
        
        async function attemptAutoplay() {
            if (autoplayAttempted || !audioReady) return;
            
            console.log('🚀 自動再生試行中...');
            autoplayAttempted = true;
            
            try {
                // まずメイン音声で試行
                const playPromise = mainAudio.play();
                
                if (playPromise !== undefined) {
                    await playPromise;
                    console.log('✅ メイン音声自動再生成功！');
                }
            } catch (error) {
                console.log('⚠️ メイン音声自動再生失敗:', error.message);
                
                try {
                    // バックアップ音声で再試行
                    const backupPromise = backupAudio.play();
                    
                    if (backupPromise !== undefined) {
                        await backupPromise;
                        console.log('✅ バックアップ音声自動再生成功！');
                    }
                } catch (backupError) {
                    console.log('❌ 自動再生完全失敗:', backupError.message);
                    showManualPlayOption();
                }
            }
        }
        
        function onPlayStart() {
            if (isPlaying) return;
            
            isPlaying = true;
            console.log('🎵 再生開始');
            
            musicIcon.textContent = '🔊';
            status.innerHTML = '🎵 音声再生中...';
            successMsg.style.display = 'block';
            controls.classList.add('visible');
            
            // 背景色を成功色に変更
            document.body.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
        }
        
        function onPlayEnd() {
            isPlaying = false;
            console.log('🏁 再生終了');
            
            musicIcon.textContent = '✅';
            status.innerHTML = '再生完了！';
            successMsg.innerHTML = '🎉 音声の再生が完了しました！';
        }
        
        function tryBackupAudio() {
            console.log('🔄 バックアップ音声に切り替え');
            if (audioReady) {
                backupAudio.play().catch(error => {
                    console.error('バックアップ音声も失敗:', error);
                    showError();
                });
            }
        }
        
        function showManualPlayOption() {
            status.innerHTML = '🎵 下のボタンをタップして再生開始';
            controls.classList.add('visible');
        }
        
        function showError() {
            hideLoading();
            status.innerHTML = '❌ 音声の読み込みに失敗しました';
            musicIcon.textContent = '❌';
        }
        
        function hideLoading() {
            loading.style.display = 'none';
        }
        
        // 手動再生ボタン
        function playAudio() {
            if (isPlaying) return;
            
            const audio = mainAudio.error ? backupAudio : mainAudio;
            
            audio.play().then(() => {
                console.log('👆 手動再生成功');
            }).catch(error => {
                console.error('手動再生失敗:', error);
                status.innerHTML = '❌ 再生エラー: ' + error.message;
            });
        }
        
        function stopAudio() {
            mainAudio.pause();
            backupAudio.pause();
            mainAudio.currentTime = 0;
            backupAudio.currentTime = 0;
            
            isPlaying = false;
            musicIcon.textContent = '🎵';
            status.innerHTML = '音声を停止しました';
            successMsg.style.display = 'none';
        }
        
        // デバッグ情報
        console.log('🎵 瞬間自動再生システム初期化完了');
        console.log('📱 デバイス:', navigator.userAgent);
    </script>
</body>
</html>
